name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  format-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Prettier
      run: npm install --save-dev prettier
    
    - name: Check code formatting
      run: |
        echo "ðŸŽ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        npx prettier --check "**/*.{js,json,md,yml,yaml}" || (
          echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
          echo "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤æ ¼å¼é—®é¢˜:"
          echo "  npx prettier --write \"**/*.{js,json,md,yml,yaml}\""
          exit 1
        )
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
    
    - name: Auto-fix formatting (PR only)
      if: github.event_name == 'pull_request'
      run: |
        echo "ðŸ”§ è‡ªåŠ¨ä¿®å¤æ ¼å¼é—®é¢˜..."
        npx prettier --write "**/*.{js,json,md,yml,yaml}"
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "ðŸ“ å‘çŽ°æ ¼å¼é—®é¢˜ï¼Œå·²è‡ªåŠ¨ä¿®å¤"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "style: è‡ªåŠ¨ä¿®å¤ä»£ç æ ¼å¼ [skip ci]" || true
          git push || true
        else
          echo "âœ… æ— éœ€æ ¼å¼ä¿®å¤"
        fi

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Setup ESLint
      run: |
        npm install --save-dev eslint @eslint/js
        
        # åˆ›å»ºåŸºç¡€ ESLint é…ç½®
        cat > eslint.config.js << 'EOF'
        import js from '@eslint/js';

        export default [
          js.configs.recommended,
          {
            languageOptions: {
              ecmaVersion: 2022,
              sourceType: 'module',
              globals: {
                console: 'readonly',
                process: 'readonly',
                Buffer: 'readonly',
                __dirname: 'readonly',
                __filename: 'readonly',
                module: 'readonly',
                require: 'readonly',
                global: 'readonly',
                setTimeout: 'readonly',
                setInterval: 'readonly',
                clearTimeout: 'readonly',
                clearInterval: 'readonly'
              }
            },
            rules: {
              'no-console': 'warn',
              'no-unused-vars': 'warn',
              'no-undef': 'error',
              'semi': ['error', 'always'],
              'quotes': ['error', 'double'],
              'indent': ['error', 'tab'],
              'no-trailing-spaces': 'error'
            }
          }
        ];
        EOF
    
    - name: Run ESLint
      run: |
        echo "ðŸ§¹ è¿è¡Œ ESLint æ£€æŸ¥..."
        npx eslint example.js --max-warnings 10 || (
          echo "âŒ ESLint æ£€æŸ¥å‘çŽ°é—®é¢˜"
          echo "è¯·ä¿®å¤ä¸Šè¿° lint é”™è¯¯åŽé‡æ–°æäº¤"
          exit 1
        )
        echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"

  complexity-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install complexity analysis tools
      run: |
        npm install --save-dev jscpd complexity-report
    
    - name: Check code duplication
      run: |
        echo "ðŸ” æ£€æŸ¥ä»£ç é‡å¤åº¦..."
        npx jscpd . --threshold 10 --reporters html,console --output ./jscpd-report || true
        
        if [ -f "./jscpd-report/jscpd-report.html" ]; then
          echo "ðŸ“Š ä»£ç é‡å¤åº¦æŠ¥å‘Šå·²ç”Ÿæˆ"
        fi
    
    - name: Analyze code complexity
      run: |
        echo "ðŸ“ˆ åˆ†æžä»£ç å¤æ‚åº¦..."
        
        # ç®€å•çš„å¤æ‚åº¦åˆ†æž
        echo "## ðŸ“Š ä»£ç å¤æ‚åº¦åˆ†æž" > complexity-report.md
        echo "" >> complexity-report.md
        
        # è®¡ç®—æ–‡ä»¶è¡Œæ•°
        LINES=$(wc -l example.js | cut -d' ' -f1)
        echo "- **example.js**: $LINES è¡Œ" >> complexity-report.md
        
        # æ£€æŸ¥å‡½æ•°æ•°é‡
        FUNCTIONS=$(grep -c "function\|=>" example.js || echo 0)
        echo "- **å‡½æ•°æ•°é‡**: $FUNCTIONS" >> complexity-report.md
        
        # æ£€æŸ¥æ³¨é‡Šè¦†ç›–çŽ‡
        COMMENTS=$(grep -c "^\s*\/\/\|^\s*\/\*" example.js || echo 0)
        COMMENT_RATIO=$(echo "scale=2; $COMMENTS * 100 / $LINES" | bc -l 2>/dev/null || echo "0")
        echo "- **æ³¨é‡Šè¦†ç›–çŽ‡**: ${COMMENT_RATIO}%" >> complexity-report.md
        
        echo "" >> complexity-report.md
        echo "### å»ºè®®" >> complexity-report.md
        
        if [ "$LINES" -gt 200 ]; then
          echo "- âš ï¸  æ–‡ä»¶è¡Œæ•°è¾ƒå¤šï¼Œè€ƒè™‘æ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å—" >> complexity-report.md
        else
          echo "- âœ… æ–‡ä»¶å¤§å°é€‚ä¸­" >> complexity-report.md
        fi
        
        if [ "$(echo "$COMMENT_RATIO < 10" | bc -l 2>/dev/null || echo 1)" -eq 1 ]; then
          echo "- âš ï¸  æ³¨é‡Šè¾ƒå°‘ï¼Œå»ºè®®å¢žåŠ ä»£ç æ³¨é‡Š" >> complexity-report.md
        else
          echo "- âœ… æ³¨é‡Šè¦†ç›–çŽ‡è‰¯å¥½" >> complexity-report.md
        fi
        
        cat complexity-report.md
    
    - name: Upload quality reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: |
          complexity-report.md
          jscpd-report/
        retention-days: 30

  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Check documentation completeness
      run: |
        echo "ðŸ“š æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§..."
        
        echo "## ðŸ“‹ æ–‡æ¡£æ£€æŸ¥æŠ¥å‘Š" > doc-report.md
        echo "" >> doc-report.md
        
        # æ£€æŸ¥ README æ–‡ä»¶
        if [ -f README.md ]; then
          echo "âœ… README.md å­˜åœ¨" >> doc-report.md
          
          # æ£€æŸ¥ README å†…å®¹
          if grep -q "å®‰è£…" README.md || grep -q "installation" README.md; then
            echo "âœ… åŒ…å«å®‰è£…è¯´æ˜Ž" >> doc-report.md
          else
            echo "âš ï¸  ç¼ºå°‘å®‰è£…è¯´æ˜Ž" >> doc-report.md
          fi
          
          if grep -q "ä½¿ç”¨" README.md || grep -q "usage" README.md; then
            echo "âœ… åŒ…å«ä½¿ç”¨è¯´æ˜Ž" >> doc-report.md
          else
            echo "âš ï¸  ç¼ºå°‘ä½¿ç”¨è¯´æ˜Ž" >> doc-report.md
          fi
        else
          echo "âŒ ç¼ºå°‘ README.md æ–‡ä»¶" >> doc-report.md
        fi
        
        # æ£€æŸ¥ä»£ç æ³¨é‡Š
        if grep -q "^\s*\/\/" example.js; then
          echo "âœ… ä»£ç åŒ…å«æ³¨é‡Š" >> doc-report.md
        else
          echo "âš ï¸  ä»£ç ç¼ºå°‘æ³¨é‡Š" >> doc-report.md
        fi
        
        # æ£€æŸ¥è®¸å¯è¯æ–‡ä»¶
        if [ -f LICENSE ] || [ -f LICENSE.md ]; then
          echo "âœ… åŒ…å«è®¸å¯è¯æ–‡ä»¶" >> doc-report.md
        else
          echo "âš ï¸  ç¼ºå°‘è®¸å¯è¯æ–‡ä»¶" >> doc-report.md
        fi
        
        cat doc-report.md
    
    - name: Upload documentation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: documentation-report
        path: doc-report.md
        retention-days: 30
