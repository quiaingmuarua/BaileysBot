name: Update Baileys Submodule

on:
  schedule:
    # æ¯å‘¨ä¸€ä¸Šåˆ 9:00 (UTC) æ£€æŸ¥æ›´æ–°
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–° submodule'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-submodule:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Check for submodule updates
      id: check-updates
      run: |
        cd baileys
        git fetch origin
        
        CURRENT_COMMIT=$(git rev-parse HEAD)
        LATEST_COMMIT=$(git rev-parse origin/master)
        
        echo "current-commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
        echo "latest-commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
        
        if [ "$CURRENT_COMMIT" != "$LATEST_COMMIT" ]; then
          echo "updates-available=true" >> $GITHUB_OUTPUT
          COMMITS_BEHIND=$(git rev-list --count HEAD..origin/master)
          echo "commits-behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          echo "ğŸ” å‘ç° $COMMITS_BEHIND ä¸ªæ–°æäº¤"
        else
          echo "updates-available=false" >> $GITHUB_OUTPUT
          echo "âœ… Submodule å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
        fi
    
    - name: Update submodule
      if: steps.check-updates.outputs.updates-available == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ğŸ”„ æ›´æ–° baileys submodule..."
        git submodule update --remote baileys
        
        cd baileys
        echo "ğŸ“¦ å®‰è£…ä¾èµ–å¹¶æ„å»º..."
        npm ci
        npm run build
        cd ..
    
    - name: Test updated submodule
      if: steps.check-updates.outputs.updates-available == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ğŸ§ª æµ‹è¯•æ›´æ–°åçš„ä»£ç ..."
        npm ci
        node --check example.js
        echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
    
    - name: Create Pull Request
      if: steps.check-updates.outputs.updates-available == 'true' || github.event.inputs.force_update == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: æ›´æ–° baileys submodule
          
          - æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬: ${{ steps.check-updates.outputs.latest-commit }}
          - åŒ…å« ${{ steps.check-updates.outputs.commits-behind }} ä¸ªæ–°æäº¤
          - å·²éªŒè¯ä»£ç å…¼å®¹æ€§
        title: 'ğŸ”„ è‡ªåŠ¨æ›´æ–° Baileys Submodule'
        body: |
          ## ğŸ“¦ Submodule æ›´æ–°
          
          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºçš„ PRï¼Œç”¨äºæ›´æ–° baileys submodule åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚
          
          ### ğŸ“‹ æ›´æ–°è¯¦æƒ…
          - **å½“å‰ç‰ˆæœ¬**: `${{ steps.check-updates.outputs.current-commit }}`
          - **æœ€æ–°ç‰ˆæœ¬**: `${{ steps.check-updates.outputs.latest-commit }}`
          - **æ–°å¢æäº¤**: ${{ steps.check-updates.outputs.commits-behind }} ä¸ª
          
          ### âœ… è‡ªåŠ¨æ£€æŸ¥
          - [x] ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡
          - [x] ä¾èµ–å®‰è£…æˆåŠŸ
          - [x] Baileys æ„å»ºæˆåŠŸ
          
          ### ğŸ” è¯·æ‰‹åŠ¨éªŒè¯
          - [ ] åŠŸèƒ½æµ‹è¯•æ­£å¸¸
          - [ ] æ— ç ´åæ€§å˜æ›´
          - [ ] å…¼å®¹ç°æœ‰ä»£ç 
          
          ---
          
          **æ³¨æ„**: è¯·åœ¨åˆå¹¶å‰è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬ä¸å½“å‰ä»£ç å…¼å®¹ã€‚
          
          ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º ğŸ¤–
        branch: update/baileys-submodule
        delete-branch: true
        draft: false
        labels: |
          dependencies
          automated
          submodule
    
    - name: Notify if no updates
      if: steps.check-updates.outputs.updates-available == 'false' && github.event.inputs.force_update != 'true'
      run: |
        echo "â„¹ï¸  å½“å‰ baileys submodule å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚"
